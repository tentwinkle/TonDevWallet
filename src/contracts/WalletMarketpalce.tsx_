// const { Cell } = require('../../boc')
// const { Contract } = require('../index.js')
// const { Address, bytesToHex, BN } = require('../../utils')
// const { WalletContract } = require('./WalletContract')
import TonWeb from 'tonweb'
import { WalletContract } from './WalletContract'

const Cell = TonWeb.boc.Cell
const Contract = TonWeb.Contract
const { Address, bytesToHex, BN } = TonWeb.utils
// const WalletContract = TonWeb.Wallets

class WalletMarketplace extends WalletContract {
  declare methods: any
  declare options: any

  /**
   * @param provider    {HttpProvider}
   * @param options {any}
   */
  constructor(provider: any, options: any) {
    options.code = Cell.oneFromBoc(
      'B5EE9C7241010C0100EF000114FF00F4A413F4BCF2C80B01020120020302014804050078F28308D71820D31FD31FD31F02F823BBF263F0015132BAF2A15144BAF2A204F901541055F910F2A3F8009320D74A96D307D402FB00E83001A402F0020202CE06070201480A0B02012008090017402C8CB1FCB1FCBFFC9ED54800A91B088831C02456F8007434C0CC1C6C244C383C005B084074C7C07000638D20C235C6083E405000FE443CA8F5350C087E401C323281F2FFF2741DDD20063232C172C09633C59C3E80B2DAC4B3333260103EC03816E000153B513434C7F4C7F4FFCC200017BB39CED44D0D33F31D70BFF80011B8C97ED44D0D70B1F82E9EF23C'
    )
    super(provider, options)
    if (!this.options.walletId) this.options.walletId = 698983191 + this.options.wc

    this.methods.getPublicKey = this.getPublicKey.bind(this)
  }

  getName() {
    return 'marketplace'
  }

  /**
   * @override
   * @private
   * @param   seqno?   {number}
   * @param   withoutOp? {boolean}
   * @return {Cell}
   */
  createSigningMessage(seqno: any, withoutOp: any) {
    seqno = seqno || 0
    const message = new Cell()
    message.bits.writeUint(this.options.walletId, 32)
    if (seqno === 0) {
      // message.bits.writeInt(-1, 32);// todo: dont work
      for (let i = 0; i < 32; i++) {
        message.bits.writeBit(1)
      }
    } else {
      const date = new Date()
      const timestamp = Math.floor(date.getTime() / 1e3)
      message.bits.writeUint(timestamp + 60, 32)
    }
    message.bits.writeUint(seqno, 32)
    if (!withoutOp) {
      message.bits.writeUint(0, 8) // op
    }
    return message
  }

  /**
   * @override
   * @return {Cell} cell contains wallet data
   */
  createDataCell() {
    const cell = new Cell()
    cell.bits.writeUint(0, 32)
    cell.bits.writeUint(this.options.walletId, 32)
    cell.bits.writeBytes(this.options.publicKey)
    cell.bits.writeUint(0, 1) // plugins dict empty
    return cell
  }

  /**
   * @return {Promise<BN>}
   */
  async getPublicKey() {
    const myAddress = await this.getAddress()
    return this.provider.call2(myAddress.toString(), 'get_public_key')
  }
}

export { WalletMarketplace }

// module.exports = { WalletV4ContractR1 }
